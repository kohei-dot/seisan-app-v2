# 精算アプリ v2 仕様書

## 概要

ポーカーなどのチップゲームにおける精算を行うWebアプリ。
チップの損益と場所代を合算し、最小の送金回数で精算方法を算出する。
セッションURLを共有することで複数人がリアルタイムに入力・閲覧できる。

---

## 技術スタック

| 項目 | 内容 |
|---|---|
| フロントエンド | React 18 + Vite + TypeScript |
| バックエンド | Supabase（PostgreSQL + Realtime） |
| デプロイ | Vercel（フロント）+ Supabase（BaaS） |

---

## 画面構成

```
トップ画面（/）
  └─ セッション作成 → 共有画面（トップ画面内）
                          └─ セッション画面へ → セッション画面（/session/:id）
                                                    └─ 参加者行をタップ → 入力モーダル
```

---

## 各画面の仕様

### 1. トップ画面（`/`）

| 項目 | 内容 |
|---|---|
| イベント名 | テキスト入力。デフォルト：起動日の日付（例: 2026/02/28） |
| 係数 | 数値入力（円/チップ）。デフォルト：5 |
| 参加者登録 | 名前のリストを登録（追加・削除可能） |

- 全項目入力済み かつ 参加者2人以上で「セッション作成」ボタンが有効
- 「セッション作成」でDBにセッション・参加者を保存し、共有画面に切り替わる

### 1-b. 共有画面（トップ画面内の状態切り替え）

- 「グループを作成しました。みんなにURLを共有しましょう」というメッセージを表示
- セッションURLを表示し、コピーボタンでクリップボードにコピーできる
- 「セッション画面へ」ボタンで `/session/:id` に遷移

---

### 2. セッション画面（`/session/:id`）

URLを知っている全員がアクセス・編集可能（ログイン不要）。

#### ① 入力結果セクション

- 全参加者を一覧表示
- 入力済みの参加者：購入チップ・最終チップ・場所代の値を表示
- 未入力の参加者：`---` を表示
- 参加者行をタップ → 入力モーダルが開く
- `[+ 参加者を追加]` で参加者を追加可能
- 各参加者に削除ボタン（確認ダイアログあり）

#### ② 損益一覧テーブル

表示条件：全員入力済み かつ 購入チップ合計 = 最終チップ合計

| 列 | 内容 |
|---|---|
| 名前 | 参加者名（左端固定） |
| 購入 | 購入チップ数 |
| 最終 | 最終チップ数 |
| チップ損益 | (最終 - 購入) × 係数（円） |
| 場所代 | その人が実際に払った場所代（円） |
| 精算額 | 最終損益（円）。プラス=緑、マイナス=赤 |

#### ③ 精算方法

表示条件：②と同じ

- 誰が誰にいくら払うかを最小送金数で表示
- 精算不要な場合は「精算は不要です」と表示

#### 条件未達時のメッセージ

②③を表示できない場合、その理由をすべて表示する。

- 未入力者がいる場合：「{名前}が入力していません」
- 合計不一致の場合：「購入チップ{X}と最終チップ{Y}が一致していません」

#### リアルタイム同期

- Supabase Realtime により、誰かが入力・編集・削除した内容が全員の画面に即時反映

---

### 3. 入力モーダル

参加者行をタップするとセッション画面上にオーバーレイで表示。

| 項目 | 型 | 備考 |
|---|---|---|
| 購入チップ | 数値 | inputmode="numeric" |
| 最終チップ | 数値 | inputmode="numeric" |
| 場所代（円） | 数値 | inputmode="numeric"、未入力は0扱い |

- 「保存」でDBに書き込み、モーダルを閉じる
- 「キャンセル」で変更を破棄してモーダルを閉じる

---

## 計算ロジック

```
チップ損益 = (最終チップ - 購入チップ) × 係数

一人あたり場所代 = 全員の場所代合計 ÷ 参加人数

最終損益（精算額）= チップ損益 + (自分が払った場所代 - 一人あたり場所代)
```

- 端数は円単位で四捨五入
- 丸め後の合計が0にならない場合は最も損している人の値を調整して合計を0にする
- 調整が発生した場合「端数調整あり」バッジを表示

### 最小送金数アルゴリズム

1. 全員の精算額を昇順ソート
2. 最も負の人（支払い最大）と最も正の人（受け取り最大）をマッチング
3. 小さい方が0になったらポインタを進める
4. 全員が0になるまで繰り返す

n人の場合、最大 n-1 回の送金で完了する。

---

## DB設計

### sessions テーブル

| カラム | 型 | 内容 |
|---|---|---|
| id | uuid | セッションID（URLに使用） |
| event_name | text | イベント名 |
| coefficient | integer | 係数（円/チップ） |
| created_at | timestamp | 作成日時 |

### participants テーブル

| カラム | 型 | 内容 |
|---|---|---|
| id | uuid | |
| session_id | uuid | sessionsへの外部キー |
| name | text | 参加者名 |
| buy_chips | integer | 購入チップ（null = 未入力） |
| final_chips | integer | 最終チップ（null = 未入力） |
| venue_fee | integer | 場所代（デフォルト0） |

- セットアップ時は name のみ登録
- 入力モーダルで buy_chips・final_chips・venue_fee を更新
- データは無期限保存。削除はSupabaseダッシュボードから手動で行う

---

## UI

- スマホファーストのレスポンシブデザイン
- 最大幅 480px、中央寄せ
- テーブルは横スクロール対応、名前列を左端に固定
